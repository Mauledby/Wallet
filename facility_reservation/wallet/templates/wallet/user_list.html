<!-- user_list.html -->
{% extends 'wallet/base.html' %}
{% load static %}

{% block body_block %}
<style>



#page-content-wrapper {
    background: url("{% static 'img/basebg.PNG' %}") no-repeat;
    background-size: cover;
    /* Add any other styles you need for #page-content-wrapper */
  }
  .jumbotron {
  background-color: rgba(254, 255, 255, 0.8); /* Darker background color */
  color: #ffffff; /* Light text color */
  /* Other styles for the jumbotron */
  
  margin: 0 auto;
}

    .jumbotron-fluid{
        width: 200px;
        height:50px;
        color: #000;
        text-size-adjust: 10px;
        border-style: solid;
        margin-bottom: 10px;
    }
  .nav-tabs .nav-link {
        margin-right: 5px; 
        color: #555; /* Default text color for inactive links */
        background-color:#e9ecef ; /* Default background color for inactive links */
    }

    .nav-tabs .nav-link.active {
        color: #ffff; /* Text color for active link (darker) */
        background-color: #9c7b16; /* Background color for active link */
    }

</style>

<div class="container custom-container" style="margin-top: 20px;">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#userListTab">User List</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#transactionsTab">Transactions</a>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane fade show active" id="userListTab">
            <div class="jumbotron">
                <h1 style="color: #000;">User List</h1>
                <table id="users" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ID No.</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Point Balance</th>
                            <th>Action</th>
                            <th>UserType</th>

                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                            <tr>
                                <td>{{ user.profile_id }}</td>
                                <td>{{ user.first_name }}</td>
                                <td>{{ user.last_name }}</td>
                                <td>{{ user.point_balance }}</td>
                                <td>
                                    <button class="btn btn-primary actionsButton" style="background-color:#9C7B16;" data-recipient="{{ user.user.id }}" data-firstname="{{user.first_name}}" data-lastname="{{user.last_name}}" data-pbal="{{user.point_balance}}" data-acctype="{% if user.user.is_superuser %}Superuser{% else %}Regular User{% endif %}">Actions</button>
                                    <!-- <button class="btn btn-primary awardPointsButton" style="background-color:#9C7B16;" data-recipient="{{ user.user.id }}">Actions</button> -->
                                </td>
                                <td>
                                    {% if user.user.is_superuser %}
                                        Superuser
                                    {% else %}
                                        Regular User
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="transactionsTab">
            <div class="jumbotron">
                <h1 style="color: #000;">Transactions</h1>
                <table id="transactions" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Recipient</th>
                            <th>Sender</th>
                            <th>Points</th>
                            <th>Date</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                            <tr>
                                <td>{{ transaction.transactionID }}</td>
                                <td>{{ transaction.recipient }}</td>
                                <td>{{ transaction.sender }}</td>
                                <td>{{ transaction.points }}</td>
                                <td>{{ transaction.date }}</td>
                                <td>{{ transaction.time }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>




    <div class="modal" id="awardPointsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Award Points</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Add the form elements for awarding points -->
                    <form id="awardPointsForm" method="post" action="">
                        {% csrf_token %}
                        <!-- Form fields for awarding points go here -->
                        <div class="form-group">
                            <label for="recipient">Target User:</label>
                            <input type="text" class="form-control" id="recipient" name="recipient" readonly>
                        </div>
                        <div class="form-group">
                            <label for="points">Points to add:</label>
                            <input type="number" class="form-control" id="points" name="points">
                        </div>
                        <div class="form-group">
                            <label for="date">Date:</label>
                            <input type="text" class="form-control" id="date" name="date" readonly>
                        </div>
                        <div class="form-group">
                            <label for="time">Time:</label>
                            <input type="text" class="form-control" id="time" name="time" readonly>
                        </div>
                        <div class="form-group">
                            <input type="hidden" name="sender" id="sender" value="{{ request.user.id }}">
                        </div>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="actionsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="margin-left: auto;" ></h5>
                    <button type="button" style="position: initial;"   class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-center"> <!-- Wrap buttons in a div with text-center class -->
                       <div class="row">

                        <div class="col">
                            <div class="jumbotron jumbotron-fluid">
                                <div class="container">
                                    <h6 class="pbal">Point Balance</h6>
                                </div>
                              </div>
                        <button class="btn btn-primary awardPointsButton" style="background-color:#9C7B16;" data-recipient="{{ user.user.id }}">Award Points</button>
                        </div>

                        <div class="col">
                            <div class="jumbotron jumbotron-fluid">
                                <div class="container">
                                  
                                    <h6 class="acctype" id="accountType">Account Type</h6>
                                </div>
                              </div>
                        <button class="btn btn-primary changetype" style="background-color:#9C7B16;" data-recipient="{{ user.user.id }}">Change Account Type</button>
                        </div>

                        </div> 
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function() {

            // Function to handle form submission
            $('#awardPointsForm').submit(function(event) {
                event.preventDefault(); // Prevent the default form submission
                
                // Retrieve the form data
                var formData = new FormData(this);
                formData.set('recipient', $('#recipient').val());
                formData.set('sender', $('#sender').val());

                // Perform the points transaction
                $.ajax({
                    url: '/wallet/user_list/',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        var awardedPoints = parseFloat($('#points').val());
                        var recipientID = $('#recipient').val();
                        var senderID = $('#sender').val();
                        var recipientName = response.recipient_name; // Access the concatenated name from the JSON response
                        var senderName = response.sender_name; // Access the concatenated name from the JSON response
                        var recipientPointBalanceCell = $('table#users td:contains("' + recipientID + '")').siblings(':nth-child(4)');
                        console.log(recipientPointBalanceCell); // Check the selected cell
                        console.log(recipientPointBalanceCell.length); // Check the length of the selected cell
                        var currentPointBalance = parseFloat(recipientPointBalanceCell.text());
                        var newPointBalance = currentPointBalance + awardedPoints;
                        recipientPointBalanceCell.text(newPointBalance.toFixed(2)); // Update the point balance in the table
                        console.log(awardedPoints); // Log the response for debugging purposes
                        // Update the point balance in the table or perform any other necessary actions
                        
                        $('#awardPointsModal').modal('hide'); // Hide the modal
                        window.location.reload()
                        window.alert("\nYOU HAVE SUCCESSFULLY COMPLETED THE TRANSACTION.\n")
                        
                        
                    },
                    error: function(xhr, status, error) {
                        // Handle the error response
                        console.error(error); // Log the error for debugging purposes
                        // Display an error message or perform any other necessary actions
                    }
                });
                
            });


            $(document).on('click', '.actionsButton', function() {
                var recipient = $(this).data('recipient');
                var firstName = $(this).data('firstname'); // Get first name from data attribute
                var lastName = $(this).data('lastname');   // Get last name from data attribute
                var pbal=$(this).data('pbal');             // get point balance from data attribute
                var acctype = $(this).data('acctype');

                // Set the title of the second modal to the user's first and last name
                $('#actionsModal .modal-title').text(firstName + ' ' + lastName);
                $('#actionsModal .pbal').text(pbal);
                $('#actionsModal .acctype').text(acctype);

                $('#actionsModal').modal('show');
                $('#actionsModal .awardPointsButton').data('recipient', recipient);
            });


            // Function to handle "Award Points" button click
            $(document).on('click', '.awardPointsButton', function() {
                $('#actionsModal').modal('hide');
                var recipient = $(this).data('recipient');
                $('#recipient').val(recipient);

                // Auto-fill date and time fields with current date and time
                var currentDate = new Date();
                var dateString = currentDate.toLocaleDateString();
                var timeString = currentDate.toLocaleTimeString();
                $('#date').val(dateString);
                $('#time').val(timeString);

                $('#awardPointsModal').modal('show');
            });
        });
    </script>
{% endblock %}
